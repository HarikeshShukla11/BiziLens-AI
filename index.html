<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiziLens AI - Grand Finale Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library Scripts - FINAL, VERIFIED, AND 100% PERMANENT FIX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js" xintegrity="sha512-7NfDCRBfgUTpeL2JllPFxk3iS3G3JquLKSgT3vS0i1k2fM5WDbL2e/2o3NisZNOkdi42G2F86d_A2lG4vT9B_Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script>
        // FIX: Embed fonts as a style block to prevent cross-origin issues with html-to-image
        const fontStyles = `
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Inter:wght@400;500;600&display=swap');
        `;
        const style = document.createElement('style');
        style.textContent = fontStyles;
        document.head.appendChild(style);

        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
    </script>
    <style>
        :root { --line-color: rgba(255, 255, 255, 0.1); }
        .dark { --line-color: rgba(0, 255, 249, 0.2); }

        body {
            font-family: 'Inter', sans-serif;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, background-color 0.3s ease;
            background-color: #f3f4f6;
        }
        .dark body { background-color: #0d0c22; }
        .loaded body { opacity: 1; }
        h1, h2, h3, h4 { font-family: 'Rajdhani', sans-serif; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .glass-card {
            background: rgba(17, 24, 39, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .fade-in-up { opacity: 0; transform: translateY(20px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
        .fade-in-up.is-visible { opacity: 1; transform: translateY(0); }
        
        #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }

        @keyframes glitch { 2%,64%{ transform: translate(2px,0) skew(0deg); } 4%,60%{ transform: translate(-2px,0) skew(0deg); } 62%{ transform: translate(0,0) skew(5deg); } }
        .glitch:before, .glitch:after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; }
        .glitch:before { left: 2px; text-shadow: -2px 0 #ff00c1; clip: rect(44px, 450px, 56px, 0); animation: glitch 3s infinite linear alternate-reverse; }
        .glitch:after { left: -2px; text-shadow: -2px 0 #00fff9, 2px 2px #ff00c1; clip: rect(86px, 450px, 140px, 0); animation: glitch 2s infinite linear alternate-reverse; }

        .neon-button {
            transition: all 0.3s ease;
            border: 1px solid #4f46e5;
        }
        .neon-button.active, .neon-button:hover {
             box-shadow: 0 0 5px #4f46e5, 0 0 15px #4f46e5, 0 0 25px #4f46e5;
             border-color: #a5b4fc;
        }
        .dark .neon-button { border: 1px solid #818cf8; }
        .dark .neon-button.active, .dark .neon-button:hover { box-shadow: 0 0 5px #818cf8, 0 0 15px #818cf8, 0 0 25px #818cf8; border-color: #c7d2fe; }
        
        .canvas-block {
            opacity: 0.5;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .canvas-block:hover, .canvas-block.highlight {
            opacity: 1;
            transform: scale(1.03);
            box-shadow: 0 0 20px var(--line-color);
            z-index: 10;
        }
        
        .line {
            position: absolute;
            background-color: var(--line-color);
            transform-origin: 0 0;
        }
        
        @media print {
            body * { visibility: hidden; }
            #canvas-to-print, #canvas-to-print * { visibility: visible; }
            #canvas-to-print { position: absolute; left: 0; top: 0; width: 100%; }
            .dark #canvas-to-print { background-color: white !important; color: black !important; }
            .dark #canvas-to-print .dark\:text-gray-100 { color: black !important; }
            .dark #canvas-to-print .dark\:text-gray-300 { color: #333 !important; }
            .dark #canvas-to-print .glass-card { background: #f9fafb !important; border: 1px solid #ccc !important; }
        }
    </style>
</head>
<body class="font-sans antialiased text-gray-800 dark:text-gray-200">
    <div id="canvas-to-print" class="hidden"></div>
    <div id="canvas-for-export" class="hidden"></div>
    <canvas id="particle-canvas"></canvas>
    
    <!-- Header -->
    <header class="bg-white/10 dark:bg-black/30 backdrop-blur-lg sticky top-0 z-50 border-b border-white/10 dark:border-white/5">
        <nav class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <a href="#home" class="text-2xl font-bold text-gray-800 dark:text-white uppercase tracking-wider">BiziLens AI</a>
                <div class="flex items-center space-x-2">
                     <div class="hidden md:flex items-center space-x-2">
                        <a href="#home" class="nav-link">Home</a>
                        <a href="#try" class="nav-link">Demo</a>
                        <a href="#features" class="nav-link">Features</a>
                    </div>
                     <button id="history-btn" class="nav-btn">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span id="history-count" class="absolute -top-1 -right-1 bg-cyan-400 text-black text-xs rounded-full h-4 w-4 flex items-center justify-center hidden"></span>
                    </button>
                    <button id="theme-toggle" class="nav-btn">
                        <svg id="theme-toggle-dark-icon" class="hidden h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>
                        <svg id="theme-toggle-light-icon" class="hidden h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" clip-rule="evenodd" /></svg>
                    </button>
                    <style>
                        .nav-link { color: #4b5563; } .dark .nav-link { color: #d1d5db; } .nav-link:hover { color: #4f46e5; } .dark .nav-link:hover { color: #818cf8; } 
                        .nav-link { padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-family: 'Rajdhani', sans-serif; font-size: 1.125rem; font-weight: 700; text-transform: uppercase; transition: color 0.2s; }
                        .nav-btn { position: relative; padding: 0.5rem; border-radius: 9999px; color: #4b5563; } .dark .nav-btn { color: #d1d5db; }
                        .nav-btn:hover { background-color: rgba(0,0,0,0.05); } .dark .nav-btn:hover { background-color: rgba(255,255,255,0.1); }
                    </style>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <!-- Hero Section -->
        <section id="home" class="relative text-center py-20 md:py-32 overflow-hidden fade-in-up">
            <div class="container mx-auto px-6 z-10 relative">
                 <h1 class="glitch text-5xl md:text-7xl font-bold text-gray-900 dark:text-white uppercase tracking-widest" data-text="BiziLens AI">
                    BiziLens AI
                </h1>
                <p class="mt-6 text-lg md:text-xl text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
                    Instantly convert your raw idea into a battle-ready Business Model Canvas. Stop strategizing, start materializing.
                </p>
                <div class="mt-10 flex justify-center items-center space-x-8">
                     <div class="text-center">
                        <p class="text-4xl font-bold text-indigo-600 dark:text-cyan-400 stat-counter" data-target="1500">0</p>
                        <p class="text-sm uppercase tracking-wider text-gray-500">Ideas Analyzed</p>
                     </div>
                     <div class="text-center">
                        <p class="text-4xl font-bold text-indigo-600 dark:text-cyan-400 stat-counter" data-target="98">0</p>
                        <p class="text-sm uppercase tracking-wider text-gray-500">% Accuracy</p>
                     </div>
                     <div class="text-center">
                        <p class="text-4xl font-bold text-indigo-600 dark:text-cyan-400 stat-counter" data-target="5">0</p>
                        <p class="text-sm uppercase tracking-wider text-gray-500">Seconds to Canvas</p>
                     </div>
                </div>
                <a href="#try" class="mt-12 inline-block px-10 py-4 bg-indigo-600 text-white font-bold text-lg uppercase tracking-wider rounded-md shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105 neon-button">
                    Launch Demo
                </a>
            </div>
        </section>
        
        <!-- Functional Demo Section -->
        <section id="try" class="py-20 fade-in-up">
            <div class="container mx-auto px-6 text-center">
                <h2 class="text-4xl font-bold text-gray-900 dark:text-white uppercase tracking-wider">AI Canvas Generator</h2>
                <div class="max-w-3xl mx-auto mt-8">
                    <div class="glass-card rounded-lg p-1">
                        <textarea id="prompt-input" class="w-full p-4 bg-transparent text-gray-800 dark:text-gray-200 rounded-lg focus:ring-0 focus:outline-none placeholder-gray-500" rows="4" placeholder="Enter your business idea here..."></textarea>
                    </div>
                     <div class="mt-4 flex flex-wrap justify-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                        <span class="font-bold">Try an example:</span>
                        <button class="example-prompt">AI meal planner</button>
                        <button class="example-prompt">Eco-friendly packaging</button>
                        <button class="example-prompt">Language learning VR</button>
                    </div>
                    <style>.example-prompt { border: 1px solid #4f46e5; color: #4f46e5; } .dark .example-prompt { border-color: #818cf8; color: #818cf8; } .example-prompt:hover { background-color: #4f46e5; color: white; } .dark .example-prompt:hover { background-color: #818cf8; color: black; } .example-prompt { padding: 0.25rem 0.75rem; border-radius: 9999px; transition: all 0.2s; font-weight: 500; }</style>
                    <button id="generate-btn" class="mt-6 px-10 py-3 bg-indigo-600 text-white font-bold text-lg uppercase tracking-wider rounded-md shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed neon-button">
                        Generate
                    </button>
                </div>
                <div id="loading-spinner" class="mt-12 hidden">
                     <div class="relative w-48 h-12 mx-auto overflow-hidden">
                        <div class="scanner-line"></div>
                        <p class="text-2xl font-bold uppercase tracking-widest text-cyan-400">ANALYZING...</p>
                    </div>
                </div>
                <div id="canvas-output" class="mt-12 text-left"></div>
            </div>
        </section>
        
        <!-- Features Section -->
        <section id="features" class="py-20 fade-in-up">
             <div class="container mx-auto px-6 text-center">
                <h2 class="text-4xl font-bold text-gray-900 dark:text-white uppercase tracking-wider">Core Features</h2>
                 <div class="grid md:grid-cols-3 gap-8 mt-12 text-left">
                    <div class="feature-card glass-card">
                        <h3 class="text-2xl font-bold">Interactive Canvas</h3>
                        <p class="mt-2 text-gray-600 dark:text-gray-400">Click to expand sections and explore your business model in detail.</p>
                    </div>
                     <div class="feature-card glass-card">
                        <h3 class="text-2xl font-bold">AI Optimization</h3>
                        <p class="mt-2 text-gray-600 dark:text-gray-400">Get actionable suggestions from a VC-trained AI to strengthen your model.</p>
                    </div>
                     <div class="feature-card glass-card">
                        <h3 class="text-2xl font-bold">Print & Share</h3>
                        <p class="mt-2 text-gray-600 dark:text-gray-400">Download a PDF, get a shareable link, or print a clean blueprint of your canvas.</p>
                    </div>
                 </div>
                 <style>.feature-card { padding: 2rem; border-radius: 0.5rem; transition: transform 0.3s ease, border-color 0.3s ease;} .feature-card:hover { transform: translateY(-5px); border-color: #818cf8; }</style>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="py-8 fade-in-up">
        <div class="container mx-auto px-6 text-center text-gray-500 dark:text-gray-400">
            <p>&copy; 2025 BiziLens AI by DreamStack.</p>
        </div>
    </footer>

    <!-- Modals (Share, Error, History) -->
    <div id="share-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0 transform scale-95"></div>
    <div id="error-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0 transform scale-95"></div>
    <div id="history-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0 transform scale-95"></div>
    
    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-cyan-400 text-black px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0">Link Copied!</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.documentElement.classList.add('loaded');
            
            // Variable declarations
            const generateBtn = document.getElementById('generate-btn');
            const promptInput = document.getElementById('prompt-input');
            const loadingSpinner = document.getElementById('loading-spinner');
            const canvasOutput = document.getElementById('canvas-output');
            const errorModal = document.getElementById('error-modal');
            const shareModal = document.getElementById('share-modal');
            const historyBtn = document.getElementById('history-btn');
            const historyModal = document.getElementById('history-modal');
            const historyCount = document.getElementById('history-count');
            const examplePrompts = document.querySelectorAll('.example-prompt');
            const themeToggleBtn = document.getElementById('theme-toggle');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            const toastNotification = document.getElementById('toast-notification');
            const canvasToPrint = document.getElementById('canvas-to-print');
            const canvasForExport = document.getElementById('canvas-for-export');
            
            // --- API Key Management ---
            // The provided API key is now hardcoded.
            const geminiApiKey = "AIzaSyBdpHnBeGJ0M8KPBnddZfGUemr_mZ1QMLE";

            // --- Particle Background ---
            const canvas = document.getElementById('particle-canvas');
            const ctx = canvas.getContext('2d');
            let particles = [];
            
            function initParticles() {
                particles = [];
                let numberOfParticles = (window.innerWidth * document.body.scrollHeight) / 20000;
                for (let i = 0; i < numberOfParticles; i++) particles.push(new Particle());
            }

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = document.body.scrollHeight;
                initParticles();
            }
            window.addEventListener('resize', resizeCanvas);
            
            class Particle {
                 constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.size = Math.random() * 2 + 1;
                    this.speedX = (Math.random() * 1 - 0.5) / 2;
                    this.speedY = (Math.random() * 1 - 0.5) / 2;
                }
                update() {
                    this.x += this.speedX; this.y += this.speedY;
                    if (this.size > 0.2) this.size -= 0.01;
                    if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
                    if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
                }
                draw() {
                    ctx.fillStyle = document.documentElement.classList.contains('dark') ? 'rgba(0, 255, 249, 0.5)' : 'rgba(79, 70, 229, 0.5)';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            function animateParticles() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                for (let i = 0; i < particles.length; i++) {
                    particles[i].update();
                    particles[i].draw();
                }
                requestAnimationFrame(animateParticles);
            }
            
            resizeCanvas();
            animateParticles();

            // --- Animated Counters ---
            function animateCounters() {
                const counters = document.querySelectorAll('.stat-counter');
                const speed = 200; 
                counters.forEach(counter => {
                    const updateCount = () => {
                        const target = +counter.getAttribute('data-target');
                        const count = +counter.innerText;
                        const inc = target / speed;
                        if (count < target) {
                            counter.innerText = Math.ceil(count + inc);
                            setTimeout(updateCount, 10);
                        } else {
                            counter.innerText = target;
                        }
                    };
                    updateCount();
                });
            }

            // --- Sound Effect ---
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            function playSound(type = 'pop') {
                if (audioContext.state === 'suspended') audioContext.resume();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if(type === 'pop') {
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.5);
                } else if (type === 'optimize') {
                     oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(100, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.3);
                    gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.3);
                }

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }
            
            // --- Theme Toggle ---
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { lightIcon.classList.remove('hidden'); } else { darkIcon.classList.remove('hidden'); }
            themeToggleBtn.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                darkIcon.classList.toggle('hidden');
                lightIcon.classList.toggle('hidden');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                setTimeout(resizeCanvas, 100);
            });

            // --- Typewriter Effect & Generate Button Activation ---
            promptInput.addEventListener('input', () => {
                if (promptInput.value.trim() !== '') {
                    generateBtn.classList.add('active');
                } else {
                    generateBtn.classList.remove('active');
                }
            });
            function typeWriter(element, text, i = 0) {
                if (i === 0) element.value = "";
                if (i < text.length) {
                    element.value += text.charAt(i);
                    element.dispatchEvent(new Event('input'));
                    setTimeout(() => typeWriter(element, text, i + 1), 20);
                }
            }
            const examplePromptTexts = {
                "AI meal planner": "An app that uses AI to create personalized meal plans for busy professionals based on their dietary needs and local grocery availability.",
                "Eco-friendly packaging": "A B2B service that provides compostable and reusable packaging solutions for e-commerce businesses to reduce waste.",
                "Language learning VR": "A virtual reality application that immerses users in real-life scenarios to help them practice and learn a new language conversationally."
            };
            examplePrompts.forEach(btn => btn.addEventListener('click', () => typeWriter(promptInput, examplePromptTexts[btn.textContent])));

            // --- History Management ---
            let canvasHistory = JSON.parse(localStorage.getItem('biziLensHistory')) || [];
            const updateHistoryUI = () => {
                if (canvasHistory.length > 0) {
                    historyCount.textContent = canvasHistory.length;
                    historyCount.classList.remove('hidden');
                } else {
                    historyCount.classList.add('hidden');
                }
            };
            const saveToHistory = (canvasData, prompt, id) => {
                const newEntry = { id, prompt, canvasData, date: new Date().toISOString() };
                canvasHistory.unshift(newEntry);
                if (canvasHistory.length > 10) canvasHistory.pop();
                localStorage.setItem('biziLensHistory', JSON.stringify(canvasHistory));
                updateHistoryUI();
            };
            historyBtn.addEventListener('click', () => {
                 historyModal.innerHTML = `
                    <div class="glass-card rounded-lg shadow-2xl p-6 w-full max-w-2xl transform transition-all border border-white/10">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-white uppercase">Canvas History</h2>
                            <button id="close-history-modal-btn" class="p-2 rounded-full text-gray-400 hover:bg-white/10 text-2xl leading-none">&times;</button>
                        </div>
                        <div id="history-list" class="max-h-96 overflow-y-auto pr-2">
                           ${canvasHistory.length > 0 ? canvasHistory.map(item => `
                                <div class="history-item mb-3 p-3 border border-white/10 rounded-lg hover:bg-white/5 cursor-pointer" data-id="${item.id}">
                                    <p class="font-semibold truncate text-white">${item.prompt}</p>
                                    <p class="text-xs text-gray-400">${new Date(item.date).toLocaleString()}</p>
                                </div>`).join('') : '<p class="text-center text-gray-400 py-8">No history yet.</p>'}
                        </div>
                         ${canvasHistory.length > 0 ? '<button id="clear-history-btn" class="mt-4 text-sm text-red-500 hover:underline">Clear History</button>' : ''}
                    </div>
                `;
                historyModal.classList.remove('hidden');
                setTimeout(() => historyModal.classList.remove('opacity-0', 'scale-95'), 10);
                document.getElementById('close-history-modal-btn').addEventListener('click', () => { historyModal.classList.add('opacity-0', 'scale-95'); setTimeout(() => historyModal.classList.add('hidden'), 300); });
                document.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const id = item.getAttribute('data-id');
                        const historyEntry = canvasHistory.find(entry => entry.id === id);
                        if (historyEntry) {
                            renderCanvas(historyEntry.canvasData, historyEntry.prompt);
                             historyModal.classList.add('opacity-0', 'scale-95');
                             setTimeout(() => historyModal.classList.add('hidden'), 300);
                        }
                    });
                });
                if (document.getElementById('clear-history-btn')) {
                    document.getElementById('clear-history-btn').addEventListener('click', () => {
                        if(confirm('Are you sure you want to clear all history? This cannot be undone.')){
                            canvasHistory = [];
                            localStorage.removeItem('biziLensHistory');
                            updateHistoryUI();
                            document.getElementById('history-list').innerHTML = '<p class="text-center text-gray-400 py-8">History cleared.</p>';
                        }
                    });
                }
            });
            
            const callGeminiAPI = async (prompt) => {
                if (!geminiApiKey) {
                    showErrorModal("The API Key is missing. Please contact the developer.");
                    return null;
                }
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`); }
                    const result = await response.json();
                    let textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!textResponse) { throw new Error("Invalid response structure from AI."); }
                    const cleanedResponse = textResponse.replace(/^```json\n?/, '').replace(/```$/, '');
                    
                    // FIX: More robust JSON parsing
                    try {
                        return JSON.parse(cleanedResponse);
                    } catch (parseError) {
                        console.error("JSON Parse Error. Raw response from AI:", cleanedResponse);
                        throw new Error("AI returned an invalid format. Please try generating again.");
                    }

                } catch (error) {
                    console.error("Gemini API Error:", error);
                    showErrorModal(`AI se communicate karne mein galti hui: ${error.message}`);
                    return null;
                }
            };
            
            generateBtn.addEventListener('click', async () => {
                const userPrompt = promptInput.value;
                if (!userPrompt) { showErrorModal('Pahle apna idea ya problem statement likhein!'); return; }
                canvasOutput.innerHTML = '';
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generating...';
                loadingSpinner.classList.remove('hidden');
                const systemPrompt = `Act as an expert business analyst. Based on the user's idea, generate a complete Business Model Canvas. Your response MUST be a valid JSON object with the following keys: "keyPartners", "keyActivities", "valuePropositions", "customerRelationships", "customerSegments", "keyResources", "channels", "costStructure", "revenueStreams". User's idea: "${userPrompt}"`;
                const canvasData = await callGeminiAPI(systemPrompt);
                loadingSpinner.classList.add('hidden');
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate';
                if (canvasData) {
                    const canvasId = `canvas-${Date.now()}`;
                    saveToHistory(canvasData, userPrompt, canvasId);
                    renderCanvas(canvasData, userPrompt);
                    canvasOutput.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
            
            function getIcon(title) {
                const icons = {
                    'Key Partners': '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 21a6 6 0 004.773-9.805A4 4 0 0012 4.354M12 12.75a4.5 4.5 0 110-9 4.5 4.5 0 010 9z" /></svg>',
                    'Key Activities': '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>',
                    'Value Propositions': '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>',
                    'Customer Relationships': '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>',
                    'Customer Segments': '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>',
                    'Key Resources': '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7h1a2 2 0 012 2v5a2 2 0 01-2 2h-1m-6 0H6a2 2 0 01-2-2V9a2 2 0 012-2h1M9 7h6m-6 10h6m-6-5h6" /></svg>',
                    'Channels': '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" /></svg>',
                    'Cost Structure': '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01" /></svg>',
                    'Revenue Streams': '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>',
                };
                return icons[title] || '';
            }

            function renderCanvas(data, originalPrompt) {
                // Prepare a clean table for PDF export
                const exportableHTML = `
                    <div style="font-family: 'Inter', sans-serif; padding: 2rem; color: #111827;">
                        <h1 style="text-align: center; font-size: 2.25rem; font-weight: 700; margin-bottom: 2rem; color: #111827;">Business Model Canvas</h1>
                        <h2 style="text-align: center; font-size: 1.25rem; margin-bottom: 2rem; color: #4b5563;">For the idea: ${originalPrompt}</h2>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tbody>
                                ${Object.keys(data).map(key => {
                                    let content = data[key];
                                    if(Array.isArray(content)) {
                                        content = content.map(item => `<li>${item}</li>`).join('');
                                        content = `<ul>${content}</ul>`;
                                    }
                                    return `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="width: 30%; padding: 1rem; font-weight: 700; vertical-align: top; font-family: 'Rajdhani', sans-serif;">${key.replace(/([A-Z])/g, ' $1').trim()}</td>
                                        <td style="padding: 1rem;">${content}</td>
                                    </tr>
                                    `
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                canvasForExport.innerHTML = exportableHTML;
                
                // Render the interactive canvas for the screen
                const canvasHTML = `
                    <div id="canvas-to-download" class="p-4 sm:p-6 glass-card rounded-lg border-t border-white/20 canvas-grid-bg relative">
                        <h3 class="text-3xl font-bold text-center mb-8 text-gray-800 dark:text-gray-100 uppercase tracking-wider">Business Model Canvas</h3>
                        <div id="bmc-grid" class="grid grid-cols-10 grid-rows-6 gap-2">
                            ${createCanvasBlock('Key Partners', data.keyPartners, 'border-cyan-400', 'col-span-2 row-span-4')}
                            ${createCanvasBlock('Key Activities', data.keyActivities, 'border-indigo-400', 'col-start-3 col-span-2 row-span-2')}
                            ${createCanvasBlock('Key Resources', data.keyResources, 'border-indigo-400', 'col-start-3 col-span-2 row-start-3 row-span-2')}
                            ${createCanvasBlock('Value Propositions', data.valuePropositions, 'border-green-400', 'col-start-5 col-span-2 row-span-4')}
                            ${createCanvasBlock('Customer Relationships', data.customerRelationships, 'border-orange-400', 'col-start-7 col-span-2 row-span-2')}
                            ${createCanvasBlock('Channels', data.channels, 'border-orange-400', 'col-start-7 col-span-2 row-start-3 row-span-2')}
                            ${createCanvasBlock('Customer Segments', data.customerSegments, 'border-yellow-400', 'col-start-9 col-span-2 row-span-4')}
                            ${createCanvasBlock('Cost Structure', data.costStructure, 'border-red-400', 'col-span-5 row-start-5 row-span-2')}
                            ${createCanvasBlock('Revenue Streams', data.revenueStreams, 'border-purple-400', 'col-start-6 col-span-5 row-start-5 row-span-2')}
                        </div>
                         <div id="canvas-lines" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>
                    </div>
                    <!-- Action Buttons -->
                    <div class="mt-8 flex flex-wrap justify-center items-center gap-4">
                        <button id="optimize-btn" class="action-btn">✨ AI Optimize</button>
                        <button id="print-btn" class="action-btn">🖨️ Print</button>
                        <button id="download-image-btn" class="action-btn">🖼️ Download Image</button>
                        <button id="download-pdf-btn" class="action-btn">📄 Download PDF</button>
                        <button id="share-btn" class="action-btn">Share</button>
                        <button id="start-over-btn" class="action-btn">Start Over</button>
                    </div>
                    <div id="optimization-output" class="mt-12 text-left"></div>
                    <style>.action-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1.5rem; color: white; font-weight: 700; border-radius: 0.375rem; transition: all 0.2s; text-transform: uppercase; } .action-btn:hover { background: rgba(255,255,255,0.2); border-color: #00fff9; color: #00fff9; text-shadow: 0 0 5px #00fff9; }</style>
                `;
                canvasOutput.innerHTML = canvasHTML;
                
                const blocks = canvasOutput.querySelectorAll('.canvas-block');
                blocks.forEach((block, index) => { 
                    setTimeout(() => { 
                        block.classList.add('fade-in-up', 'is-visible'); 
                        playSound('pop'); 
                    }, index * 100);
                    block.addEventListener('click', () => {
                        blocks.forEach(b => { if (b !== block) b.classList.remove('expanded'); });
                        block.classList.toggle('expanded');
                    });
                });
                
                setTimeout(drawCanvasLines, blocks.length * 100);

                document.getElementById('download-pdf-btn').addEventListener('click', handleDownloadPdf);
                document.getElementById('download-image-btn').addEventListener('click', handleDownloadImage);
                document.getElementById('share-btn').addEventListener('click', () => handleShare(data));
                document.getElementById('start-over-btn').addEventListener('click', () => { canvasOutput.innerHTML = ''; promptInput.value = ''; });
                document.getElementById('optimize-btn').addEventListener('click', () => handleOptimize(data, originalPrompt));
                document.getElementById('print-btn').addEventListener('click', handlePrint);
            }
            
            function drawCanvasLines() {
                const container = document.getElementById('canvas-lines');
                if (!container) return;
                container.innerHTML = ''; 
                const grid = document.getElementById('bmc-grid');
                const blocks = Array.from(grid.children).reduce((acc, el) => {
                    acc[el.dataset.title] = el;
                    return acc;
                }, {});

                function connect(b1, b2) {
                    if (!b1 || !b2) return;
                    const rect1 = b1.getBoundingClientRect();
                    const rect2 = b2.getBoundingClientRect();
                    const gridRect = grid.getBoundingClientRect();
                    let x1 = (rect1.left - gridRect.left) + rect1.width / 2;
                    let y1 = (rect1.top - gridRect.top) + rect1.height / 2;
                    let x2 = (rect2.left - gridRect.left) + rect2.width / 2;
                    let y2 = (rect2.top - gridRect.top) + rect2.height / 2;
                    createLine(x1, y1, x2, y2);
                }
                
                function createLine(x1, y1, x2, y2) {
                    const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
                    const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                    const line = document.createElement('div');
                    line.className = 'line';
                    line.style.position = 'absolute';
                    line.style.backgroundColor = 'var(--line-color)';
                    line.style.height = '2px';
                    line.style.left = `${x1}px`;
                    line.style.top = `${y1}px`;
                    line.style.width = `${length}px`;
                    line.style.transformOrigin = '0 0';
                    line.style.transform = `rotate(${angle}deg)`;
                    container.appendChild(line);
                }

                connect(blocks['KeyActivities'], blocks['ValuePropositions']);
                connect(blocks['KeyResources'], blocks['ValuePropositions']);
                connect(blocks['KeyPartners'], blocks['KeyActivities']);
                connect(blocks['ValuePropositions'], blocks['CustomerRelationships']);
                connect(blocks['ValuePropositions'], blocks['Channels']);
                connect(blocks['CustomerRelationships'], blocks['CustomerSegments']);
                connect(blocks['Channels'], blocks['CustomerSegments']);
                connect(blocks['CostStructure'], blocks['KeyActivities']);
                connect(blocks['RevenueStreams'], blocks['CustomerSegments']);
            }

            async function handleOptimize(canvasData, originalPrompt) {
                const btn = document.getElementById('optimize-btn');
                btn.disabled = true; btn.innerHTML = 'Optimizing...';
                playSound('optimize');
                const optimizationOutput = document.getElementById('optimization-output');
                optimizationOutput.innerHTML = '<div class="relative w-48 h-12 mx-auto overflow-hidden"><div class="scanner-line"></div><p class="text-2xl font-bold uppercase tracking-widest text-cyan-400">OPTIMIZING...</p></div>';
                const optimizationPrompt = `Act as a world-class venture capitalist. You are reviewing the following Business Model Canvas for the idea "${originalPrompt}". Provide actionable, concise suggestions (2-3 bullet points max for each) to improve each section. Your response MUST be a valid JSON object with keys matching the canvas sections: "keyPartners", "keyActivities", etc. The value for each key should be a string containing your bulleted suggestions. Original Canvas: ${JSON.stringify(canvasData)}`;
                const suggestions = await callGeminiAPI(optimizationPrompt);
                if (suggestions) {
                    optimizationOutput.innerHTML = `
                        <div class="glass-card p-6 rounded-lg border-t border-cyan-400/50 mt-8">
                           <h3 class="text-3xl font-bold text-center mb-6 text-cyan-400 uppercase tracking-wider">AI Optimization Suggestions</h3>
                           <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${Object.keys(suggestions).map(key => `
                                    <div class="suggestion-card p-4 rounded-lg glass-card border-l-2 border-cyan-400" data-target-block="${key}">
                                       <h4 class="font-bold text-white uppercase text-sm mb-2">${key.replace(/([A-Z])/g, ' $1').trim()}</h4>
                                       <div class="text-sm text-gray-300">${suggestions[key].replace(/\*/g, '<br>• ')}</div>
                                    </div>
                                `).join('')}
                           </div>
                        </div>
                    `;
                    document.querySelectorAll('.suggestion-card').forEach(card => {
                        const targetBlockTitle = card.dataset.targetBlock;
                        const targetBlock = document.querySelector(`.canvas-block[data-title="${targetBlockTitle}"]`);
                        if (targetBlock) {
                            card.addEventListener('mouseenter', () => targetBlock.classList.add('highlight'));
                            card.addEventListener('mouseleave', () => targetBlock.classList.remove('highlight'));
                        }
                    });
                } else {
                     optimizationOutput.innerHTML = '<p class="text-center text-red-500">Could not get optimization suggestions.</p>';
                }
                btn.disabled = false; btn.innerHTML = '✨ AI Optimize';
            }

            function createCanvasBlock(title, content, color, gridClass = '') {
                const icon = getIcon(title);
                let formattedContent = 'N/A';
                if (content) {
                    if (Array.isArray(content)) { formattedContent = '<ul>' + content.map(item => `<li class="list-disc ml-4">${item}</li>`).join('') + '</ul>'; } 
                    else if (typeof content === 'string') { formattedContent = content.replace(/\n/g, '<br>'); } 
                    else { formattedContent = String(content); }
                }

                return `<div data-title="${title.replace(/\s+/g, '')}" class="p-4 rounded-lg flex flex-col canvas-block glass-card border-l-4 ${color} fade-in-up h-full cursor-pointer ${gridClass}">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <span class="text-cyan-400">${icon}</span>
                                    <h3 class="font-bold text-gray-100 text-base uppercase tracking-wider">${title}</h3>
                                </div>
                                <span class="text-cyan-400 expand-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                </span>
                            </div>
                            <div class="text-sm text-gray-300 canvas-block-content">
                                ${formattedContent}
                            </div>
                        </div>`;
            }

            function handlePrint() {
                const canvasContent = document.getElementById('canvas-to-download');
                if (canvasContent) {
                    canvasToPrint.innerHTML = canvasContent.outerHTML;
                    window.print();
                    canvasToPrint.innerHTML = '';
                }
            }
            
            function handleDownloadImage() {
                const btn = document.getElementById('download-image-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = 'Downloading...';
                btn.disabled = true;
                const element = document.getElementById('canvas-to-download');
                
                htmlToImage.toPng(element, { 
                    backgroundColor: document.documentElement.classList.contains('dark') ? '#0d0c22' : '#f3f4f6', 
                    quality: 0.98,
                })
                .then(function (dataUrl) {
                    const link = document.createElement('a');
                    link.download = 'BiziLens-AI-Canvas.png';
                    link.href = dataUrl;
                    link.click();
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                })
                .catch(function (error) {
                    console.error('oops, something went wrong!', error);
                    showErrorModal('Image download failed. Please try again.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            }

            function handleDownloadPdf() {
                const btn = document.getElementById('download-pdf-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Downloading...';
                btn.disabled = true;
                const element = document.getElementById('canvas-for-export');
                const opt = {
                    margin: 0.5,
                    filename: 'BiziLens-AI-Canvas.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                };
                html2pdf().set(opt).from(element).save().then(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                });
            }

            function handleShare(data) {
                const dataStr = btoa(JSON.stringify(data));
                const shareUrl = `${window.location.origin}${window.location.pathname}?canvas=${dataStr}`;
                
                shareModal.innerHTML = `
                    <div class="glass-card rounded-lg shadow-2xl p-6 w-full max-w-lg transform transition-all border border-white/10">
                         <h2 class="text-2xl font-bold mb-4 text-white">Share Your Canvas</h2>
                         <div class="mb-4">
                             <label class="block text-sm font-bold mb-2 text-gray-400" for="share-url-input">Shareable Link</label>
                             <div class="flex">
                                 <input id="share-url-input" type="text" readonly value="${shareUrl}" class="w-full p-2 border rounded-l bg-black/20 border-white/10 text-white">
                                 <button id="copy-link-btn" class="px-4 py-2 bg-cyan-500 text-black rounded-r font-bold">Copy</button>
                             </div>
                         </div>
                         <div class="mb-4">
                            <label class="block text-sm font-bold mb-2 text-gray-400" for="email-input">Share via Email (comma separated)</label>
                            <input id="email-input" type="email" multiple placeholder="friend1@example.com, friend2@example.com" class="w-full p-2 border rounded bg-black/20 border-white/10 text-white">
                         </div>
                         <div class="flex justify-end gap-2">
                            <button id="send-email-btn" class="action-btn">Send Email</button>
                            <button id="close-share-modal-btn" class="action-btn">Close</button>
                         </div>
                    </div>
                `;
                shareModal.classList.remove('hidden');
                setTimeout(() => shareModal.classList.remove('opacity-0', 'scale-95'), 10);

                document.getElementById('copy-link-btn').addEventListener('click', () => {
                    const input = document.getElementById('share-url-input');
                    input.select();
                    document.execCommand('copy');
                    showToast('Link Copied!');
                });
                document.getElementById('send-email-btn').addEventListener('click', () => {
                    const emails = document.getElementById('email-input').value;
                    if (emails) {
                        const subject = "Check out my Business Model Canvas from BiziLens AI!";
                        const body = `I generated a business model canvas for my idea. You can view it here: ${shareUrl}`;
                        window.location.href = `mailto:${emails}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    }
                });
                document.getElementById('close-share-modal-btn').addEventListener('click', () => {
                     shareModal.classList.add('opacity-0', 'scale-95');
                     setTimeout(() => shareModal.classList.add('hidden'), 300);
                });
            }

            function showErrorModal(message) {
                 errorModal.innerHTML = `
                    <div class="glass-card rounded-lg shadow-2xl p-6 w-full max-w-md text-center transform transition-all border border-white/10">
                         <h2 class="text-2xl font-bold text-red-500 mb-4">Error</h2>
                         <p class="text-gray-300 mb-6">${message}</p>
                         <button id="close-error-modal-btn" class="action-btn">Okay</button>
                    </div>
                 `;
                errorModal.classList.remove('hidden');
                setTimeout(() => errorModal.classList.remove('opacity-0', 'scale-95'), 10);
                document.getElementById('close-error-modal-btn').addEventListener('click', () => {
                    errorModal.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => errorModal.classList.add('hidden'), 300);
                });
            }
            
            function showToast(message) {
                toastNotification.textContent = message;
                toastNotification.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    toastNotification.classList.add('translate-y-20', 'opacity-0');
                }, 3000);
            }

            // --- Initial Load Logic ---
            const urlParams = new URLSearchParams(window.location.search);
            const sharedCanvasData = urlParams.get('canvas');
            if(sharedCanvasData) { try { const canvasData = JSON.parse(atob(sharedCanvasData)); renderCanvas(canvasData, "Shared Canvas"); } catch(e) { console.error("Error parsing shared canvas data:", e); } }
            const sections = document.querySelectorAll('.fade-in-up');
            const observer = new IntersectionObserver(entries => { 
                entries.forEach(entry => { 
                    if (entry.isIntersecting) { 
                        entry.target.classList.add('is-visible');
                        if (entry.target.querySelector('.stat-counter')) {
                            animateCounters();
                        }
                    } 
                }); 
            }, { threshold: 0.1 });
            sections.forEach(section => observer.observe(section));
            updateHistoryUI();
        });
    </script>
</body>
</html>

